
<!DOCTYPE html>
<head>

	<title>Out of the Garden | Charity Routes</title>

	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<meta name="description" content="View Wake Forest University shuttles in realtime. 
	Find out shuttle times, stops, and route directions." />
	<meta name="KEYWORDS" content="ridethewake, shuttle, shuttles, bus schedule, schedules, Wake Forest shuttle service,
	Wake Forest University shuttle service, WFU shuttle, shuttle service, Wake Forest apartment shuttles,
	Wake Forest University apartment shuttles, Wake Line, Gray Line, Black Line, downtown shuttle, Gold Line" />

	<link rel="icon" type="image/png" href="favicon.ico">

	<link type="text/css" rel="stylesheet" href="style.css" />

	<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js"></script>

	<!--<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>-->

	
	<script type="text/javascript">

		var mapReferenceObject;

		var shuttleMarkerReference;

		var shuttleMarkerInfoWindow;

		var shuttleLocation = [];

		var mapPolyLine;

		var shuttleLines = [];

		var polyLine = [];

		var stopMarkers = [];

		var infoWindows = [];

		var stopTimes = [];

		var refreshFunction;

		var geocoder;

		var warehouse=new google.maps.LatLng(36.068616,-79.961352);

		var school=new google.maps.LatLng(36.080456,-79.866621);		//Morehead Elementary

		var markers = [];

		var polyLines = [];

		shuttleLines.push(["black",12,36.0733679,-79.7916424,48,45,44,"black","Black Line"]);
			
		function initialize()
		{
	        
	        var mapOptions = { center: {lat:36.073265,lng:-79.789955}, zoom: 11, mapTypeId:google.maps.MapTypeId.ROADMAPs};

	        var map = new google.maps.Map(document.getElementById('mapCanvas'), mapOptions);

	        geocoder = new google.maps.Geocoder();

			markers.push(new google.maps.Marker({
				position: warehouse,
				title: 'Warehouse'
			}));
			
			markers.push(new google.maps.Marker({
				position: school,
				title: 'School'
			}));
			
			for (i = 0; i < markers.length; i++)
			{
			markers[i].setMap(map);
			}

	        mapReferenceObject = map;

			var myTrip = [warehouse,school];
			polyLines.push(new google.maps.Polyline({
			  path:myTrip,
			  strokeColor:"#0078E7",
			  strokeOpacity:0.7,
			  strokeWeight:6.5
			  }));

			polyLines[0].setMap(map);
			

	        loadLine(0, map);

	    }


	    /*function displayRoute() {
	    
	    	var start = new google.maps.LatLng(36.0733679, -79.7916424);
	    	var end = new google.maps.LatLng(36.069212, -79.799215);
	    
	    	var directionsDisplay = new google.maps.DirectionsRenderer();// also, constructor can get "DirectionsRendererOptions" object
	    	directionsDisplay.setMap(map); // map should be already initialized.
	    	
	    	var request = {
	    		origin : start,
	    		destination : end,
	    		travelMode : google.maps.TravelMode.DRIVING
	    	};
	        var directionsService = new google.maps.DirectionsService(); 
	    	directionsService.route(request, function(response, status) {
	    		if (status == google.maps.DirectionsStatus.OK) {
	    			directionsDisplay.setDirections(response);
	    		}
	    	});
	    }*/

	    
	    google.maps.event.addDomListener(window, 'load', initialize);

	    function getLocation()
	    {
    		if (navigator.geolocation)
    		{
        		navigator.geolocation.watchPosition(showPosition);
    		}
    		else
    		{ 
        		x.innerHTML = "Geolocation is not supported by this browser.";
        	}
    	}

		function loadLine(lineID, map)
		{

			//go thru these and see which ones you don't need

	        loadPolyline(lineID, map);

	        downloadStopsFile(lineID);

			initializeShuttleMarker(lineID, map);

	        autoRefresh(lineID, map);

		}


	    function loadPolyline(lineID, map)
		{

			downloadRouteFile(lineID);


			if (mapPolyLine == null)
			{

				mapPolyLine = new google.maps.Polyline({

					geodesic: false,
					strokeOpacity: 0.7,
					map: map,
					strokeWeight: 5

				});

			}

			mapPolyLine.setOptions({strokeColor:rgbToHex(shuttleLines[lineID][4], shuttleLines[lineID][5], shuttleLines[lineID][6])});

			mapPolyLine.setPath(polyLine);

		}

		function rgbToHex(r, g, b)
		{

    		return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);

		}

		function downloadRouteFile(lineID)
		{

			$.ajax({
			type: "GET",
			url: "routes/"+shuttleLines[lineID][0]+"Route.csv",
			dataType: "text",
			async: false,
			success: function(data) { processRouteCoordinates(data); }
			});

		}

		function processRouteCoordinates(routeCoordinatesData)
		{

			if(polyLine != [])
			{

				polyLine = [];

			}

		    var coordinateData = routeCoordinatesData.split(/\r\n|\n/);

		    for (var i=0; i<coordinateData.length; i++)
		    {

		        var data = coordinateData[i].split(',');

	            var coordinate = new google.maps.LatLng(data[0],data[1]);

	            polyLine.push(coordinate);

		    }

		}

		function downloadStopsFile(lineID)
		{

			$.ajax({
			type: "GET",
			url: "stops/"+shuttleLines[lineID][0]+"Stops.xml",
			dataType: "text",
			async: false,
			success: function(data) { loadStops(data, lineID); }
			});

		}

		function loadStops(data, lineID)
		{

			$(data).find('stop').each(function()
			{

				var stop = [];
				stop[0] = $(this).attr("name");
				stop[1] = $(this).attr("times");

				stopTimes.push(stop);

			    var stopCoordinates = new google.maps.LatLng($(this).attr("coordinateLat"),$(this).attr("coordinateLon"));

			    var stopMarker = new google.maps.Marker({
				    position: stopCoordinates,
				    map: mapReferenceObject
			    });

				var infowindow = new google.maps.InfoWindow({
			      content: "<div class='infoWindow'><b>"+$(this).attr('name')+"</b><br>"+$(this).attr("times")+"</div>"
			 	});

			 	google.maps.event.addListener(stopMarker, 'click', function() {
			    	infowindow.open(mapReferenceObject,stopMarker);
			 	});

			 	stopMarkers.push(stopMarker);

			 	infoWindows.push(infowindow);

		    });

		    $(data).find('stopInformation').each(function()
		    {
		    	stopTimes.push($(this).attr("info"));
		    });

		}

		function clearMarkers()
		{

			for (var i = 0; i < stopMarkers.length; i++) {
    			stopMarkers[i].setMap(null);
  			}

  			stopMarkers = [];

  			for (var i = 0; i < infoWindows.length; i++) {
    			infoWindows[i].setMap(null);
  			}

  			infoWindows = [];

  			stopTimes = [];

  			shuttleMarkerReference.setMap(null);

		}

		function initializeShuttleMarker(lineID, map)
		{
			
		    var image ='img/shuttleMarkers/'+shuttleLines[lineID][0]+'ShuttleMarker.png';

		    downloadShuttleLocation(lineID);

		    var shuttleCoordinates = new google.maps.LatLng(shuttleLocation[0],shuttleLocation[1]);

		    shuttleMarkerReference = new google.maps.Marker({
			    position: shuttleCoordinates,
			    zIndex: 100,
			    map: map,
			    icon: image
		    });

		   	shuttleMarkerInfoWindow = new google.maps.InfoWindow({
		      content: "<div class='infoWindow'>Updated at "+shuttleLocation[2]+".<br>There are "+shuttleLocation[3]+" passengers.</div>",
		      maxWidth: 200
		 	});

		 	google.maps.event.addListener(shuttleMarkerReference, 'click', function()
		 	{

		    	shuttleMarkerInfoWindow.open(map,shuttleMarkerReference);

		 	});

		}

		function downloadShuttleLocation(lineID)
		{

			$.ajax({
			type: "GET",
			url: ""+shuttleLines[lineID][7]+".xml",
			dataType: "text",
			async: false,
			success: function(data) { setShuttleLocationData(data); }
			});

		}

		function setShuttleLocationData(data)
		{
		
			$(data).find('marker').each(function()
			{

			    shuttleLocation[0] = $(this).attr("lat");
			    shuttleLocation[1] = $(this).attr("lng");
			    var str = $(this).attr("time");
			    var split = str.split(":");
			    var d = new Date(2014, 10, 20, split[0], split[1], split[2], 00);
			    shuttleLocation[2] = formatAMPM(d);
			    shuttleLocation[3] = $(this).attr("passenger");

		    });

		}

		function formatAMPM(date)
		{
			var hours = date.getHours();
			var minutes = date.getMinutes();
			var ampm = hours >= 12 ? 'pm' : 'am';
			hours = hours % 12;
			hours = hours ? hours : 12;
			minutes = minutes < 10 ? '0'+minutes : minutes;
			var strTime = hours + ':' + minutes + ' ' + ampm;
			return strTime;
		}

		function autoRefresh(lineID, mapReference)
		{

			refreshFunction = window.setInterval(function(){changeShuttleLocation(lineID, mapReference)}, 5000);

		}

		function changeShuttleLocation(lineID, mapReference)
		{

			downloadShuttleLocation(lineID);
		    
		    var shuttleCoordinates = new google.maps.LatLng(shuttleLocation[0],shuttleLocation[1]);

		    shuttleMarkerReference.setOptions({position:shuttleCoordinates});

		    shuttleMarkerInfoWindow.setOptions({content:"<div class='infoWindow'>Updated at "+shuttleLocation[2]+".<br>There are "+shuttleLocation[3]+" passengers.</div>"});

		}

		function loadShuttleSchedule(lineID)
		{

			document.getElementById("line").innerHTML = shuttleLines[lineID][8];

		}

		function showSchedule()
		{

			document.getElementById("showSchedule").innerHTML = "<a href='#' onClick='hideSchedule()'>▿ Hide shuttle schedule</a>";

			var HTML = "<table>";

			for(var j=0; j<stopTimes.length-1; j++)
			{
			    HTML += "<tr><th>"+stopTimes[j][0]+"</th></tr><tr><td>"+stopTimes[j][1]+"</td></tr>";
			}

			HTML += "</table><br>"+stopTimes[stopTimes.length-1];

			document.getElementById("scheduleContent").innerHTML = HTML;

		}

		function hideSchedule()
		{

			document.getElementById("showSchedule").innerHTML = "<a href='#' onClick='showSchedule()'>▹ Show shuttle schedule</a>";

			document.getElementById("scheduleContent").innerHTML = "";

		}

		function searchClicked()
		{
			var address1 = document.getElementById("form1").elements["starting"].value;
			var address2 = document.getElementById("form1").elements["destination"].value
			//document.getElementById("demo").innerHTML = address1;
			//window.alert(document.getElementById("form1"));
			geocoder.geocode( { 'address': address1}, function(results, status) {
				if (status == google.maps.GeocoderStatus.OK)
				{
					//map.setCenter(results[0].geometry.location);
					/*
					var marker = new google.maps.Marker({
						map: map,
						position: results[0].geometry.location
					});
					*/

					var myTrip = [results[0].geometry.location,warehouse];
					polyLines.push(new google.maps.Polyline({
					  path:myTrip,
					  strokeColor:"#1D1D1D",
					  strokeOpacity:0.7,
					  strokeWeight:6.5
					  }));
					
				
					markers[2] = new google.maps.Marker({
						position: results[0].geometry.location,
						title: 'Starting'
					});

					markers[2].setMap(mapReferenceObject);
					polyLines[1].setMap(mapReferenceObject);
					//document.getElementById("demo").innerHTML = results[0].geometry.location.lat();
				} 
				else
				{
					//window.alert("Geocode was not successful for the following reason: " + status);
				}
			});

			geocoder.geocode( { 'address': address2}, function(results, status) {
				if (status == google.maps.GeocoderStatus.OK)
				{
					//map.setCenter(results[0].geometry.location);
					/*
					var marker = new google.maps.Marker({
						map: map,
						position: results[0].geometry.location
					});
					*/
					var myTrip = [school,results[0].geometry.location];
					polyLines.push(new google.maps.Polyline({
					  path:myTrip,
					  strokeColor:"#1D1D1D",
					  strokeOpacity:0.7,
					  strokeWeight:6.5
					  }));
				
					markers[3] = new google.maps.Marker({
						position: results[0].geometry.location,
						title: 'Starting'
					});

					markers[3].setMap(mapReferenceObject);
					polyLines[2].setMap(mapReferenceObject);
					//document.getElementById("demo").innerHTML = results[0].geometry.location.lat();
				} 
				else
				{
					//window.alert("Geocode was not successful for the following reason: " + status);
				}
			});

		}

	</script>

</head>

<body>

<div id="container">


	<header>
		<div id="logo"><span class="white">Out of the Garden Project</span> Routes</div>
		<div id="searchForm">
			<form id="form1">
	    		<input type="text" class="search" name="starting" placeholder="Starting Location" required>

	    		<input type="text" class="search" name="destination" placeholder="Destination" required>
	    		<input type="button" class="searchButton" onclick="searchClicked()" value="Search">
			</form>
		</div>
	</header>

	<p id="demo"></p>

	<div id="shuttleMap">
		<div id="mapCanvas"></div>
		<!--
		<div id="statusPanel">
			<b><span id="line">Black Line</span></b>
			<br><span id="showSchedule"><a href="#" onClick="showSchedule()">▹ Show shuttle schedule</a></span>
			<div id="scheduleContent"></div>
		</div>
		-->
	</div>

	<div id="sidebar">

		<div class = "title">Delivery Routes</div>

		<ul>

					<a href="#" onclick="changeLine(0)">
				<li>

				<div class="shuttleIcon"><img src="img/shuttleIcons/blackShuttleIcon.png" width='30px' \></div>
				<div class="shuttleInfo">
					<span class="shuttleName">School A</span><br>
					<span class="shuttleStops">Warehouse to School 1</span>
				</div>

				</li>
		
		</ul>	

	</div>

</div>

</body>

</html>
